<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACI Motors - Field Data Collection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb;       /* Royal Blue */
            --primary-light: #eff6ff;
            --primary-dark: #1e40af;
            
            --secondary: #10b981;     /* Emerald */
            --secondary-light: #ecfdf5;
            
            --accent: #8b5cf6;        /* Violet (Delivery) */
            --accent-light: #f5f3ff;
            
            --info: #06b6d4;          /* Cyan (Booking) */
            --info-light: #ecfeff;
            
            --bg-body: #f8fafc;       /* Slate-50 */
            --bg-card: #ffffff;
            
            --text-main: #0f172a;     /* Slate-900 */
            --text-muted: #64748b;    /* Slate-500 */
            --border: #e2e8f0;        /* Slate-200 */
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* --- GLOBAL & ANIMATIONS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body {
            background-color: var(--bg-body);
            background: linear-gradient(-45deg, #f8fafc, #f1f5f9, #eff6ff, #f8fafc);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-main);
            line-height: 1.5;
            min-height: 100vh;
            padding-bottom: 10px; 
            font-size: 14px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100;
            padding: 0.75rem 0; margin-bottom: 1.5rem; box-shadow: var(--shadow-sm);
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-text h1 { font-size: 1.1rem; font-weight: 700; color: #15803d; }
        .logo-text p { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; }
        .user-pill {
            display: flex; align-items: center; gap: 6px; background: white; padding: 4px 12px;
            border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: var(--text-main);
            border: 1px solid var(--border); box-shadow: var(--shadow-sm);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

        /* --- DASHBOARD GRID --- */
        .page-header { margin-bottom: 1rem; opacity: 0; animation: fadeSlideUp 0.6s ease-out forwards; }
        .page-header h2 { font-size: 1.5rem; font-weight: 800; color: var(--text-main); }

        .dashboard-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 1.5rem; }
        .stat-card {
            background: var(--bg-card); border-radius: 10px; padding: 1rem; box-shadow: var(--shadow-sm);
            border: 1px solid var(--border); display: flex; flex-direction: column; justify-content: space-between;
            height: 100%; transition: all 0.3s; position: relative; overflow: hidden; min-height: 90px;
            opacity: 0; animation: fadeSlideUp 0.6s ease-out forwards;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .stat-card::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.5), transparent);
            transform: skewX(-25deg); transition: 0.5s;
        }
        .stat-card:hover::after { left: 150%; transition: 0.7s; }
        
        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .stat-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: var(--bg-body); color: var(--text-muted); }
        .stat-value { font-size: 1.6rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; margin-top: auto; }

        /* Card Colors */
        .stat-card.blue .stat-icon { background: var(--primary-light); color: var(--primary); }
        .stat-card.green .stat-icon { background: var(--secondary-light); color: var(--secondary); }
        .stat-card.orange .stat-icon { background: #fff7ed; color: #f97316; }
        .stat-card.red .stat-icon { background: #fef2f2; color: #ef4444; }
        .stat-card.booked .stat-icon { background: white; color: var(--info); }
        .stat-card.booked { background: linear-gradient(to bottom right, #fff, var(--info-light)); border-color: var(--info); }
        .stat-card.booked .stat-value { color: var(--info); }
        .stat-card.delivered .stat-icon { background: white; color: var(--accent); }
        .stat-card.delivered { background: linear-gradient(to bottom right, #fff, var(--accent-light)); border-color: var(--accent); }
        .stat-card.delivered .stat-value { color: var(--accent); }

        /* --- TOOLBAR --- */
        .toolbar {
            background: var(--bg-card); border-radius: 10px; padding: 10px; margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm); border: 1px solid var(--border); display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; align-items: end;
            opacity: 0; animation: fadeSlideUp 0.6s ease-out forwards 0.4s;
        }
        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-group label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); }
        .form-control { width: 100%; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; background-color: #f8fafc; font-size: 0.85rem; }
        .clear-btn { padding: 6px 12px; background: transparent; border: 1px dashed var(--border); color: var(--text-muted); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.75rem; height: 32px; display: flex; align-items: center; justify-content: center; }

        /* --- TABLE --- */
        .table-wrapper {
            background: var(--bg-card); border-radius: 10px; box-shadow: var(--shadow-sm);
            border: 1px solid var(--border); overflow: hidden; opacity: 0; animation: fadeSlideUp 0.6s ease-out forwards 0.5s;
        }
        .table-scroll { overflow-x: auto; overflow-y: auto; max-height: 70vh; padding-bottom: 60px; }
        
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th {
            background: #f1f5f9; padding: 0.8rem 0.5rem; text-align: left; font-size: 0.7rem; font-weight: 700; 
            text-transform: uppercase; color: var(--text-muted); border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 20; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        td { padding: 0.8rem 0.5rem; border-bottom: 1px solid var(--border); font-size: 0.85rem; vertical-align: middle; position: relative; }
        tr:hover { background-color: #f8fafc; }
        
        tr.not-visited td:first-child { border-left: 3px solid #f59e0b; }
        tr.submitted td:first-child { border-left: 3px solid var(--primary); }

        /* --- CREATIVE COMPACT PHONE PILL --- */
        td.phone-cell {
            position: relative;
            /* Allow the pill to expand outside the cell boundaries */
            overflow: visible; 
            width: 60px; /* Force small column width */
        }

        .phone-pill-wrapper {
            position: relative;
            width: 36px;
            height: 36px;
        }

        .phone-pill {
            /* Default: Circle state */
            display: flex;
            align-items: center;
            width: 36px;
            height: 36px;
            border-radius: 18px; /* Circle */
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0;
            overflow: hidden;
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); /* Bouncy spring effect */
            position: absolute;
            left: 0;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        /* The Link/Icon part */
        .phone-pill a.call-link {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            flex-shrink: 0; /* Keep circle shape */
        }
        
        .phone-pill a.call-link i { font-size: 0.9rem; }

        /* The Content part (Number + Copy) */
        .phone-content {
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            max-width: 0;
            padding-right: 0;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        /* Hover State */
        .phone-pill:hover {
            width: auto; /* Expand */
            padding-right: 12px;
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
            z-index: 100; /* Pop over other cells */
        }

        .phone-pill:hover .phone-content {
            opacity: 1;
            max-width: 200px; /* Reveal content */
            padding-left: 0;
        }

        /* Text Styling */
        .phone-display {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 0.85rem;
            letter-spacing: -0.5px;
            cursor: pointer;
        }

        .copy-trigger {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 4px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            font-size: 0.7rem;
            transition: background 0.2s;
        }
        .copy-trigger:hover { background: rgba(255,255,255,0.4); }

        /* --- INPUTS & ACTIONS --- */
        .action-group { display: flex; gap: 6px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-info { background: white; color: var(--info); border-color: var(--border); }
        .btn-accent { background: white; color: var(--accent); border-color: var(--border); }
        .btn-ghost { background: transparent; color: var(--text-muted); cursor: default; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge-yes { background: #ecfdf5; color: #059669; }
        .badge-hot { background: #fef2f2; color: #ef4444; }
        .badge-warm { background: #fff7ed; color: #f97316; }
        .badge-cold { background: #eff6ff; color: #3b82f6; }

        .input-inline { width: 100%; padding: 6px 2px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem; }
        textarea.field-notes { min-height: 36px; resize: none; overflow: hidden; transition: 0.2s; }
        textarea.field-notes:focus { min-height: 60px; border-color: var(--primary); }

        /* Utils */
        .loading { padding: 3rem; text-align: center; }
        .no-data { padding: 3rem; text-align: center; background: white; border-radius: 10px; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #1e293b; color: white; padding: 10px 16px; border-radius: 8px; z-index: 1000; transform: translateY(150%); transition: transform 0.3s; }
        .toast.show { transform: translateY(0); }
        .toast.success { background: var(--secondary); }
        .toast.error { background: #ef4444; }

        @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: repeat(3, 1fr); } .action-group { flex-direction: column; } }
        @media (max-width: 640px) { .dashboard-grid { grid-template-columns: repeat(2, 1fr); } .user-pill span { display: none; } .toolbar { grid-template-columns: 1fr 1fr; } .toolbar button { grid-column: span 2; } }
    </style>
</head>
<body>

    <div class="bg-animation">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <!-- Logo Icon Removed -->
                    <div class="logo-text"><h1>ACI Motors Limited</h1><p>Foton Portfolio</p></div>
                </div>
                <div class="user-pill"><i class="fas fa-user-circle"></i><span>Officer</span></div>
            </div>
        </div>
    </header>

    <main class="container">
        
        <div class="page-header">
            <div><h2>Dashboard</h2></div>
        </div>

        <div id="error-panel" class="error-box" style="display: none; background:#fee2e2; color:#b91c1c; padding:10px; border-radius:6px; margin-bottom:10px;">
            <span id="error-message">Error</span> <button id="retry-button" class="btn btn-primary" style="padding:2px 8px;">Retry</button>
        </div>

        <div class="dashboard-grid">
            <div class="stat-card blue">
                <div class="stat-header"><div class="stat-icon"><i class="fas fa-users"></i></div><div class="stat-value" id="total-customers">0</div></div>
                <div class="stat-label">Customers</div>
            </div>
            <div class="stat-card green">
                <div class="stat-header"><div class="stat-icon"><i class="fas fa-check"></i></div><div class="stat-value" id="completed-visits">0</div></div>
                <div class="stat-label">Visits Done</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-header"><div class="stat-icon"><i class="fas fa-clock"></i></div><div class="stat-value" id="pending-visits">0</div></div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card red">
                <div class="stat-header"><div class="stat-icon"><i class="fas fa-fire"></i></div><div class="stat-value" id="hot-customers">0</div></div>
                <div class="stat-label">Hot Leads</div>
            </div>
            <div class="stat-card booked">
                <div class="stat-header"><div class="stat-icon"><i class="fas fa-bookmark"></i></div><div class="stat-value" id="total-booked">0</div></div>
                <div class="stat-label">Booked</div>
            </div>
            <div class="stat-card delivered">
                <div class="stat-header"><div class="stat-icon"><i class="fas fa-truck"></i></div><div class="stat-value" id="total-delivered">0</div></div>
                <div class="stat-label">Delivered</div>
            </div>
        </div>

        <div class="toolbar">
            <div class="filter-group"><label>Month</label><input type="month" id="month-filter" class="form-control"></div>
            <div class="filter-group"><label>Officer</label><select id="officer-filter" class="form-control"><option value="">All</option></select></div>
            <div class="filter-group"><label>Status</label><select id="visit-filter" class="form-control"><option value="">All</option><option value="Yes">Done</option><option value="No">Pending</option></select></div>
            <div class="filter-group"><label>Type</label><select id="customer-type-filter" class="form-control"><option value="">All</option><option value="Hot">Hot</option><option value="Warm">Warm</option><option value="Cold">Cold</option></select></div>
            <button id="clear-filters" class="clear-btn">Clear Filters</button>
        </div>

        <div class="table-wrapper">
            <div class="table-scroll">
                <table id="customer-table">
                    <thead>
                        <tr>
                            <th width="40">#</th>
                            <th width="60">Contact</th> <!-- REDUCED WIDTH -->
                            <th>Name</th>
                            <th>Date</th>
                            <th>Address</th>
                            <th>Model</th>
                            <th>Officer</th>
                            <th width="75">Visit</th>
                            <th width="75">Type</th>
                            <th>Notes</th>
                            <th width="140">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Content -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="loading" id="loading-indicator"><i class="fas fa-circle-notch fa-spin fa-2x" style="color: var(--border);"></i></div>
        <div class="no-data" id="no-data-message" style="display: none;"><p>No records found.</p></div>

    </main>

    <footer><div class="container"><p>&copy; 2025 ACI Motors Ltd.</p></div></footer>
    <div class="toast" id="toast"><i class="fas fa-info-circle"></i><span id="toast-msg">Message</span></div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzFUG8hgNL0Z4EgZCBW2be06AQ-t-Zmup2F51wnePdBAfySdV-N0xw2MKrReBEB3y0G2w/exec";

        const tableBody = document.getElementById('table-body');
        const monthFilter = document.getElementById('month-filter');
        const officerFilter = document.getElementById('officer-filter');
        const visitFilter = document.getElementById('visit-filter');
        const customerTypeFilter = document.getElementById('customer-type-filter');
        const loadingIndicator = document.getElementById('loading-indicator');
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toast-msg');
        
        const totalCustomersEl = document.getElementById('total-customers');
        const totalBookedEl = document.getElementById('total-booked');
        const totalDeliveredEl = document.getElementById('total-delivered');
        const completedVisitsEl = document.getElementById('completed-visits');
        const pendingVisitsEl = document.getElementById('pending-visits');
        const hotCustomersEl = document.getElementById('hot-customers');
        
        const noDataMessage = document.getElementById('no-data-message');
        const errorPanel = document.getElementById('error-panel');
        const retryButton = document.getElementById('retry-button');
        const clearFiltersBtn = document.getElementById('clear-filters');

        let allData = [];

        document.addEventListener('DOMContentLoaded', () => { loadData(); setupEventListeners(); });

        async function loadData() {
            showLoading(true); noDataMessage.style.display='none'; errorPanel.style.display='none';
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getData&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(response.status);
                const data = await response.json();
                if (data.success && Array.isArray(data.data)) {
                    allData = data.data;
                    updateStats(allData);
                    renderTable(allData);
                    populateOfficerFilter(allData);
                    if (allData.length === 0) noDataMessage.style.display='block';
                } else throw new Error(data.error || 'Invalid data');
            } catch (error) {
                console.error(error); errorPanel.style.display='flex'; document.getElementById('error-message').textContent=error.message;
            } finally { showLoading(false); }
        }

        function updateStats(data) {
            if (!data) return;
            totalCustomersEl.textContent = data.length;
            totalBookedEl.textContent = data.filter(i => i['Booking Info']?.startsWith('BOOKED') && !i['Delivery Info']?.startsWith('SOLD')).length;
            totalDeliveredEl.textContent = data.filter(i => i['Delivery Info']?.startsWith('SOLD')).length;
            completedVisitsEl.textContent = data.filter(i => i['Visit Completed (Y/N)'] === 'Yes').length;
            pendingVisitsEl.textContent = data.filter(i => i['Visit Completed (Y/N)'] !== 'Yes').length;
            hotCustomersEl.textContent = data.filter(i => i['Customer Type'] === 'Hot').length;
        }

        function formatPhoneNumber(raw) {
            if (!raw) return { display: 'N/A', clean: '' };
            let str = String(raw).replace(/[^\d]/g, '');
            if (str.length === 10 && str.startsWith('1')) str = '0' + str;
            if (str.startsWith('880')) str = str.substring(2);
            let display = str;
            if (str.length === 11) display = str.replace(/(\d{5})(\d{6})/, '$1 $2');
            return { display: display, clean: str };
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            if (!data || data.length === 0) { noDataMessage.style.display='block'; return; }
            
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                const hasOfficer = row['Officer Name']?.trim();
                const isCompleted = row['Visit Completed (Y/N)'] === 'Yes';
                const hasAllData = isCompleted && row['Customer Type'] && row['Field Visit Notes'];
                
                if (hasAllData) tr.classList.add('submitted');
                else if (hasOfficer && !isCompleted) tr.classList.add('not-visited');
                
                tr.style.opacity = '0';
                tr.style.animation = `fadeSlideUp 0.3s ease-out forwards ${index * 0.03}s`;

                const phoneObj = formatPhoneNumber(row['Customer No']);

                tr.innerHTML = `
                    <td>${row['S.L.'] || ''}</td>
                    
                    <!-- CREATIVE COMPACT PHONE PILL -->
                    <td class="phone-cell"> 
                        <div class="phone-pill-wrapper">
                            <div class="phone-pill">
                                <a href="tel:${phoneObj.clean}" class="call-link" title="Call">
                                    <i class="fas fa-phone"></i>
                                </a>
                                <div class="phone-content">
                                    <span class="phone-display" data-copy="${phoneObj.clean}">${phoneObj.display}</span>
                                    <button class="copy-trigger" data-copy="${phoneObj.clean}" title="Copy">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                    
                    <td>${row['Name'] || ''}</td>
                    <td>${formatDate(row['Date'])}</td>
                    <td>${row['Address'] || ''}</td>
                    <td>${row['Model'] || ''}</td>
                    <td>${row['Officer Name'] || ''}</td>
                    
                    <td>
                        ${hasAllData ? `<span class="badge badge-yes">Yes</span>` : 
                        `<select class="input-inline visit-completed" data-customer="${row['Customer No']}"><option value="">-</option><option value="Yes" ${row['Visit Completed (Y/N)']==='Yes'?'selected':''}>Yes</option><option value="No" ${row['Visit Completed (Y/N)']==='No'?'selected':''}>No</option></select>`}
                    </td>
                    
                    <td>
                        ${hasAllData ? getCustomerTypeBadge(row['Customer Type']) : 
                        `<select class="input-inline customer-type" data-customer="${row['Customer No']}"><option value="">-</option><option value="Hot" ${row['Customer Type']==='Hot'?'selected':''}>Hot</option><option value="Warm" ${row['Customer Type']==='Warm'?'selected':''}>Warm</option><option value="Cold" ${row['Customer Type']==='Cold'?'selected':''}>Cold</option></select>`}
                    </td>
                    
                    <td>
                        ${hasAllData ? `<span style="color:var(--text-muted); font-size:0.8rem">${row['Field Visit Notes']}</span>` : 
                        `<textarea class="input-inline field-notes auto-grow" data-customer="${row['Customer No']}" rows="1" placeholder="Notes...">${row['Field Visit Notes']||''}</textarea>`}
                    </td>
                    
                    <td>
                        <div class="action-group">
                        ${getActionButtons(row)}
                        </div>
                    </td>
                `;
                tableBody.appendChild(tr);
                if(!hasAllData) validateRequiredFields(row['Customer No']);
            });
        }

        function getCustomerTypeBadge(type) {
            if (!type) return '-';
            return `<span class="badge badge-${type.toLowerCase()}">${type}</span>`;
        }

        function getActionButtons(row) {
            const id = row['Customer No'];
            const hasData = row['Visit Completed (Y/N)'] === 'Yes' && row['Customer Type'] && row['Field Visit Notes'];
            const isDelivered = row['Delivery Info']?.startsWith('SOLD');
            const isBooked = row['Booking Info']?.startsWith('BOOKED');
            let h = '';
            
            if (hasData) h += `<span class="btn-ghost"><i class="fas fa-check"></i>Done</span>`;
            else if (!row['Officer Name']?.trim()) h += `<span class="btn-ghost" style="opacity:0.5">Pending</span>`;
            else h += `<button class="btn btn-primary submit-btn" data-customer="${id}">Submit</button>`;

            if (isBooked && !isDelivered) h += `<span class="btn-ghost" style="color:var(--info)"><i class="fas fa-bookmark"></i> Booked</span>`;
            else if (hasData && !isDelivered) h += `<button class="btn btn-info book-btn" data-customer="${id}">Booked?</button>`;

            if (isDelivered) h += `<span class="btn-ghost" style="color:var(--accent)"><i class="fas fa-truck"></i> Delivered</span>`;
            else if (hasData) h += `<button class="btn btn-accent deliver-btn" data-customer="${id}">Delivered?</button>`;
            
            return h;
        }

        function populateOfficerFilter(data) {
            const offs = [...new Set(data.map(r => r['Officer Name']).filter(n=>n))];
            officerFilter.innerHTML = '<option value="">All</option>';
            offs.forEach(o => officerFilter.add(new Option(o, o)));
        }

        function setupEventListeners() {
            [monthFilter, officerFilter, visitFilter, customerTypeFilter].forEach(el => el.addEventListener('change', filterTable));
            retryButton.onclick = loadData;
            clearFiltersBtn.onclick = () => { monthFilter.value=officerFilter.value=visitFilter.value=customerTypeFilter.value=''; filterTable(); };
            
            document.addEventListener('click', e => {
                const cp = e.target.closest('[data-copy]');
                if (cp) {
                    const txt = cp.dataset.copy;
                    const el = document.createElement('textarea'); el.value = txt; document.body.appendChild(el); el.select();
                    try { document.execCommand('copy'); showToast('Copied', 'success'); } catch(e){}
                    document.body.removeChild(el);
                }
                if (e.target.closest('.submit-btn')) submitRow(e.target.closest('.submit-btn').dataset.customer);
                if (e.target.closest('.book-btn')) markStatus(e.target.closest('.book-btn'), 'markBooked', 'Booking Info', 'BOOKED');
                if (e.target.closest('.deliver-btn')) markStatus(e.target.closest('.deliver-btn'), 'markDelivered', 'Delivery Info', 'SOLD');
            });
            
            document.addEventListener('input', e => {
                if (e.target.matches('.visit-completed, .customer-type, .field-notes')) validateRequiredFields(e.target.dataset.customer);
                if (e.target.matches('.auto-grow')) { e.target.style.height='auto'; e.target.style.height=e.target.scrollHeight+'px'; }
            });
        }

        function validateRequiredFields(id) {
            const r = document.querySelector(`tr:has([data-customer="${id}"])`);
            if(!r) return;
            const v=r.querySelector('.visit-completed'), t=r.querySelector('.customer-type'), n=r.querySelector('.field-notes'), b=r.querySelector('.submit-btn');
            if(v&&t&&n&&b) {
                const ok = v.value && t.value && n.value;
                b.disabled = !ok;
                [v,t,n].forEach(e => e.classList.toggle('input-error', !e.value));
            }
        }

        function filterTable() {
            const m = monthFilter.value;
            const o = officerFilter.value;
            const v = visitFilter.value;
            const t = customerTypeFilter.value;

            const res = allData.filter(r => {
                // Filter by Month
                if (m) {
                    if (!r['Date']) return false;
                    const d = new Date(r['Date']);
                    if (isNaN(d.getTime())) return false; // Handle invalid dates safely
                    
                    // Use local date components (YYYY-MM) to avoid timezone shifts
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const rowMonth = `${year}-${month}`;
                    
                    if (rowMonth !== m) return false;
                }

                if(o && r['Officer Name']!==o) return false;
                if(v && r['Visit Completed (Y/N)']!==v) return false;
                if(t && r['Customer Type']!==t) return false;
                
                return true;
            });
            renderTable(res); updateStats(res);
        }

        async function submitRow(id) {
            const v=document.querySelector(`.visit-completed[data-customer="${id}"]`).value;
            const t=document.querySelector(`.customer-type[data-customer="${id}"]`).value;
            const n=document.querySelector(`.field-notes[data-customer="${id}"]`).value;
            if(!v||!t||!n) return showToast('Fill all fields', 'error');
            
            const b = document.querySelector(`.submit-btn[data-customer="${id}"]`);
            const old = b.innerHTML; b.innerHTML='...'; b.disabled=1;
            
            try {
                const res = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams({action:'updateRow', customerNo:id, 'Visit Completed (Y/N)':v, 'Customer Type':t, 'Field Visit Notes':n})});
                const d = await res.json();
                if(!d.success) throw new Error(d.error);
                showToast('Saved', 'success');
                const row = allData.find(r=>r['Customer No']===id);
                if(row) { row['Visit Completed (Y/N)']=v; row['Customer Type']=t; row['Field Visit Notes']=n; }
                updateStats(allData); filterTable();
            } catch(e) { console.error(e); showToast('Failed', 'error'); b.innerHTML=old; b.disabled=0; }
        }

        async function markStatus(b, act, f, pre) {
            const id = b.dataset.customer; const old=b.innerHTML; b.innerHTML='...'; b.disabled=1;
            try {
                const res = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams({action:act, customerNo:id})});
                const d = await res.json();
                if(!d.success) throw new Error(d.error);
                showToast('Updated', 'success');
                const row = allData.find(r=>r['Customer No']===id);
                if(row) row[f]=pre;
                updateStats(allData); filterTable();
            } catch(e) { console.error(e); showToast('Failed', 'error'); b.innerHTML=old; b.disabled=0; }
        }

        function formatDate(s) { if(!s) return '-'; const d=new Date(s); return isNaN(d)?s:d.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'2-digit'}); }
        function showLoading(b) { loadingIndicator.style.display = b?'flex':'none'; }
        function showToast(m, t) { toastMsg.textContent=m; toast.className=`toast show ${t}`; setTimeout(()=>toast.classList.remove('show'),3000); }
    </script>
</body>
</html>
